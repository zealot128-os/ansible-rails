---
- hosts: localhost
  remote_user: root
  vars:
    rails_env: production
    app_domain: "{{ ansible_all_ipv4_addresses | last }}"
    app_name: 'app'
    app_user: 'app'
    ruby_version: '2.2'
    app_path: '/home/app/app'
    bundle_without:
      - test
  roles:
  - role: debops.users
    users: yes
    users_list:
      - name: "{{ app_user }}"
        groups:
        - 'www-data'
        state: 'present'

  - ruby/rvm
  - ruby/postgresql
  - ruby/sqlite3

  - rails/folders
  - rails/logrotate
  - role: user/profile
    rails_user_name: "{{ app_user }}"
    rails_user_bashrc_lines:
    - "cd {{ RAILS_APP_BASE_PATH }} || true"
    - "cd {{ RAILS_APP_CURRENT_PATH }} || true"
    rails_user_env:
      RAILS_ENV: "{{ rails_env }}"
      SECRET_KEY_BASE: "{{ app_secret_key_base }}"
      RAILS_LOG_FILE_PATH: "{{ RAILS_APP_LOG_PATH }}"
      DATABASE_URL: "{{ DATABASE_URL }}"

  - role: upstart/userjobs
    users:
    - "{{ app_user }}"
  - webrick/service
  - nginx/server
  - nginx/webrick

